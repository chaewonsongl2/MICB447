---
title: "Project 2_R"
output: html_notebook
---

```{r}
#### R SCRIPT - HISEAS DATASET - ALPHA DIVERSITY PLOTS

# Load CRAN packages
library(tidyverse)
library(vegan)
library(ape)

# Load Bioconductor packages
library(phyloseq)

# Load additional ggplot packages
library(ggplot2)
library(ggthemes)

# Define the set of random numbers
set.seed(800)

# Define name of metadata file
metadata_file <- "hiseas_metadata.txt"
# Load the metadata file
```

```{r}
# Load CRAN packages
library(tidyverse)
library(vegan)
library(ape)

# Load Bioconductor packages
library(phyloseq)
library(DESeq2)
```
```{r}
# Calculate relative abundance
calculate_relative_abundance <- function(x) x / sum(x)

# Calculate geometric mean 
calculate_gm_mean <- function(x, na.rm = TRUE) {
  exp(sum(log(x[x > 0]), na.rm = na.rm) / length(x))
}
```

```{r Import from QIIME}
biom_file <- import_biom("table-with-taxonomy.biom")
metadata  <- import_qiime_sample_data("hiseas_metadata.txt")
tree      <- read_tree_greengenes("tree.nwk")

# Convert from multichotomous to dichotmous tree
tree <- multi2di(tree)

# Combine all information into a single phyloseq object
physeq <- merge_phyloseq(biom_file, metadata, tree)
physeq_rar <- rarefy_even_depth(physeq, sample.size = 30000)
```
```{r}
head(sample_data(physeq))
```
```{r}
colnames(tax_table(physeq)) <- c("Kingdom", "Phylum", "Class","Order", "Family",
                                 "Genus", "Species")
tax_table(physeq)
```

```{r}
total_counts <- taxa_sums(physeq)
relative_abundance <- calculate_relative_abundance(total_counts)
```

```{r} 
abundant <- relative_abundance > 0.0005 
abundant_taxa <- prune_taxa(abundant, physeq)
abundant_taxa
```


```{r}
species <- tax_glom(physeq, taxrank = "Species", NArm = FALSE)
species
```

```{r}
deseq_plastic <- phyloseq_to_deseq2(abundant_plastic_genera, ~ orig_env_material)
geo_means <- apply(counts(deseq_plastic), 1, calculate_gm_mean)
deseq_plastic <- estimateSizeFactors(deseq_plastic, geoMeans = geo_means)
deseq_plastic <- DESeq(deseq_plastic, fitType = "local")

plastic_diff_abund <- results(deseq_plastic)
```

```{r}
ord <- ordinate(physeq, method = "PCoA", distance = "wunifrac")

plot_ordination(physeq,
                ord,
                color = "orig_env_material")+
  # Define title of plot
  labs(title = "PCoA (weighted UniFrac)") +
  theme_bw()+
  stat_ellipse(type = "norm", size = 0.5)
```

```{r}
#Install Microeco CRAN packages
install.packages("microeco")
install.packages("file2meco")
install.packages("picante")
install.packages("GUniFrac")
install.packages("ggalluvial")
install.packages("ggh4x")
install.packages("ggpubr")
install.packages("randomForest")
install.packages("igraph")
install.packages("rgexf")
install.packages("htmlwidgets")
```

```{r}
#Load Microeco CRAN Packages
library(here)
library(tidyverse)
library(microeco)
library(cowplot)
library(file2meco)
library(picante)
library(GUniFrac)
library(ggalluvial)
library(ggh4x)
library(ggpubr)
library(randomForest)
library(igraph)
library(rgexf)
library(htmlwidgets)
```
```{r}
## set.seed is used to fix the random number generation to make the results repeatable
set.seed(800)
theme_set(theme_bw(base_size=18))
calculate_relative_abundance <- function(x) x/sum(x)
```

```{r}
#Import qza artifacts to microeco
(meco_data<-qiime2meco(
    ASV_data=here::here("hiseas-table.qza"),
    phylo_tree=here::here("hiseas-rooted-tree.qza"),
    taxonomy_data=here::here("hiseas-taxonomy.qza",
    sample_data = here::here("hiseas_metadata.txt"))))
```
```{r}
head(meco_data$otu_table)
meco_data$sample_table
head(meco_data$tax_table)
#Create a dummy copy of our dataset
(dataset <- clone(meco_data))
```

```{r}
#Data processing 
dataset$sample_sums()
```
```{r}
#Filter by metadata
#Filter the samples to only include surface samples
dataset$sample_table <- dataset$sample_table %>% filter(`collection_device` == "swab")
dataset$tidy_dataset()
#Rarefy filtered data
dataset$rarefy_samples(sample.size = 1000)
```

```{r Relative Abundance}
#Calculate relative abundance
dataset$cal_abund(rel=T)
typeof(dataset$taxa_abund)
names(dataset$taxa_abund)
dataset$taxa_abund$Class [1:5,1:5]
```
```{r Removing Low Abundant Features}
#Removing low abundant features
total_counts <- dataset$taxa_sums()
relative_abundance <- calculate_relative_abundance(total_counts)
#filter out low abundant features
abundant <- relative_abundance > 0.0005 
dataset$tidy_dataset()
```
```{r Taxonomic Level}
#extract relative abundance information on Genera
genera_RA <- dataset$taxa_abund$Genus %>% as_tibble(rownames = "Feature_Taxonomy")

#Only a snippet shown
head(genera_RA)
genera_RA <- genera_RA %>% pivot_longer(-Feature_Taxonomy, values_to = "Relative_Abundance", names_to = "SampleID")

#Now we can join this with the metadata and plot
genera_RA <- genera_RA %>% left_join(dataset$sample_table)

#Split up feature taxonomy
genera_RA <- genera_RA %>% separate(Feature_Taxonomy, into = c("k","p","c","o","f","g"), sep = "\\|")
ggplot(filter(genera_RA, g =="g__Akkermansia"), aes(x=subject, y = Relative_Abundance)) +
  geom_boxplot()
```


```{R Abundance Plots}
#Creating a Venn Diagram comparing wood and plastic
surface_venn_dataset<- meco_data$merge_samples(use_group = "orig_env_material")
surface_venn_dataset
# create trans_venn object
t1 <- trans_venn$new(surface_venn_dataset, ratio = "numratio")
```

```{r}

```


